"""æµ´å®¤é¡µé¢ UI æ§åˆ¶å™¨ã€‚

è¦†ç›–æ¸¸æˆ **æµ´å®¤** (ä¿®ç†èˆ°èˆ¹) é¡µé¢çš„å¯¼èˆªäº¤äº’ã€‚

é¡µé¢å…¥å£:
    - ä¸»é¡µé¢ â†’ åé™¢ â†’ æµ´å®¤
    - å‡ºå¾å‡†å¤‡ â†’ å³ä¸Šè§’ ğŸ”§ â†’ æµ´å®¤ (è·¨çº§å¿«æ·é€šé“)

é¡µé¢å¸ƒå±€::

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ â—  æµ´å®¤                                       [é€‰æ‹©ä¿®ç†] âŠ• â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                                              â”‚
    â”‚  ä¿®ç†ä½ 1:  â– â– â– â– â–¡â–¡  ä¿®ç†ä¸­  å‰©ä½™ 03:42                     â”‚
    â”‚  ä¿®ç†ä½ 2:  ç©ºé—²                                            â”‚
    â”‚  ä¿®ç†ä½ 3:  ç©ºé—²                                            â”‚
    â”‚  ä¿®ç†ä½ 4:  ç©ºé—²        (å¯èƒ½éœ€è¦æ‰©å»º)                       â”‚
    â”‚                                                              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¯¼èˆªç›®æ ‡:

- **é€‰æ‹©ä¿®ç†**: å³ä¸Šè§’æŒ‰é’®ï¼Œè¿›å…¥é€‰æ‹©è¦ä¿®ç†çš„èˆ°èˆ¹

è·¨çº§é€šé“:

- ä»å‡ºå¾å‡†å¤‡é¡µé¢å¯ç›´æ¥è¿›å…¥æµ´å®¤ (æ—§ä»£ç çš„ cross-edge)
- æµ´å®¤å¯ç›´æ¥è¿”å›ä¸»é¡µé¢ (è·¨çº§è·³è¿‡åé™¢)

åæ ‡ä½“ç³»:
    æ‰€æœ‰åæ ‡ä¸ºç›¸å¯¹å€¼ (0.0â€“1.0)ï¼Œç”± 960Ã—540 ç»å¯¹åæ ‡æ¢ç®—ã€‚

.. note::
    é¡µé¢åƒç´ ç­¾åæš‚æœªé‡‡é›† (TODO)ã€‚å½“å‰ä»…å£°æ˜æ‹“æ‰‘å…³ç³»å’Œæ“ä½œæ¥å£ã€‚

ä½¿ç”¨æ–¹å¼::

    from autowsgr.ui.bath_page import BathPage

    page = BathPage(ctrl)
    page.go_to_choose_repair()
    page.go_back()
"""

from __future__ import annotations

import numpy as np
from loguru import logger

from autowsgr.emulator.controller import AndroidController
from autowsgr.ui.page import click_and_wait_for_page
from autowsgr.vision.matcher import (
    MatchStrategy,
    PixelChecker,
    PixelRule,
    PixelSignature,
)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# é¡µé¢è¯†åˆ«ç­¾å
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PAGE_SIGNATURE = PixelSignature(
    name="æµ´åœºé¡µ",
    strategy=MatchStrategy.ALL,
    rules=[
        PixelRule.of(0.8458, 0.1102, (74, 132, 178), tolerance=30.0),
        PixelRule.of(0.8604, 0.0889, (253, 254, 255), tolerance=30.0),
        PixelRule.of(0.8734, 0.0454, (52, 146, 198), tolerance=30.0),
        PixelRule.of(0.9875, 0.1019, (69, 133, 181), tolerance=30.0),
    ],
)
"""æµ´å®¤é¡µé¢åƒç´ ç­¾åã€‚"""


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ç‚¹å‡»åæ ‡
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CLICK_BACK: tuple[float, float] = (0.022, 0.058)
"""å›é€€æŒ‰é’® (â—)ã€‚

.. note::
    å›é€€ç›®æ ‡å–å†³äºå…¥å£è·¯å¾„:
    - ä»åé™¢è¿›å…¥ â†’ è¿”å›åé™¢
    - ä»å‡ºå¾å‡†å¤‡è·¨çº§è¿›å…¥ â†’ è¿”å›ä¸»é¡µé¢ (æ—§ä»£ç è¡Œä¸º)
    å½“å‰å®ç°ç»Ÿä¸€ä½¿ç”¨ â— æŒ‰é’®ã€‚
"""

CLICK_CHOOSE_REPAIR: tuple[float, float] = (0.9375, 0.0556)
"""é€‰æ‹©ä¿®ç†æŒ‰é’® (å³ä¸Šè§’)ã€‚

åæ ‡æ¢ç®—: æ—§ä»£ç  (900, 30) Ã· (960, 540)ã€‚
"""


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# é¡µé¢æ§åˆ¶å™¨
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


class BathPage:
    """æµ´å®¤é¡µé¢æ§åˆ¶å™¨ã€‚

    Parameters
    ----------
    ctrl:
        Android è®¾å¤‡æ§åˆ¶å™¨å®ä¾‹ã€‚
    """

    def __init__(self, ctrl: AndroidController) -> None:
        self._ctrl = ctrl

    # â”€â”€ é¡µé¢è¯†åˆ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    @staticmethod
    def is_current_page(screen: np.ndarray) -> bool:
        """åˆ¤æ–­æˆªå›¾æ˜¯å¦ä¸ºæµ´å®¤é¡µé¢ã€‚

        é€šè¿‡ 4 ä¸ªç‰¹å¾åƒç´ ç‚¹å…¨éƒ¨åŒ¹é…åˆ¤å®šã€‚

        Parameters
        ----------
        screen:
            æˆªå›¾ (HÃ—WÃ—3, RGB)ã€‚
        """
        result = PixelChecker.check_signature(screen, PAGE_SIGNATURE)
        return result.matched

    # â”€â”€ å¯¼èˆª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def go_to_choose_repair(self) -> None:
        """ç‚¹å‡»å³ä¸Šè§’æŒ‰é’®ï¼Œè¿›å…¥é€‰æ‹©ä¿®ç†ã€‚

        Raises
        ------
        NavigationError
            è¶…æ—¶ä»åœ¨æµ´å®¤é¡µé¢ã€‚
        """
        logger.info("[UI] æµ´å®¤ â†’ é€‰æ‹©ä¿®ç†")
        # é€‰æ‹©ä¿®ç†é¡µé¢æš‚æ— ç­¾åï¼Œä½¿ç”¨ leave é™çº§
        from autowsgr.ui.page import wait_leave_page

        self._ctrl.click(*CLICK_CHOOSE_REPAIR)
        wait_leave_page(
            self._ctrl,
            BathPage.is_current_page,
            source="æµ´å®¤",
            target="é€‰æ‹©ä¿®ç†",
        )

    # â”€â”€ å›é€€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def go_back(self) -> None:
        """ç‚¹å‡»å›é€€æŒ‰é’® (â—)ã€‚

        å›é€€ç›®æ ‡å–å†³äºå…¥å£è·¯å¾„:

        - ä»åé™¢è¿›å…¥ â†’ è¿”å›åé™¢
        - ä»å‡ºå¾å‡†å¤‡è·¨çº§è¿›å…¥ â†’ å¯èƒ½è¿”å›ä¸»é¡µé¢

        ä½¿ç”¨åé™¢ç­¾åéªŒè¯ã€‚è‹¥è¿”å›ä¸»é¡µé¢ä¹Ÿèƒ½é€šè¿‡ (å·²ç¦»å¼€æµ´å®¤) åˆ¤å®šã€‚

        Raises
        ------
        NavigationError
            è¶…æ—¶ä»åœ¨æµ´å®¤é¡µé¢ã€‚
        """
        from autowsgr.ui.page import wait_leave_page

        logger.info("[UI] æµ´å®¤ â†’ è¿”å›")
        self._ctrl.click(*CLICK_BACK)
        wait_leave_page(
            self._ctrl,
            BathPage.is_current_page,
            source="æµ´å®¤",
            target="åé™¢/ä¸»é¡µé¢",
        )
