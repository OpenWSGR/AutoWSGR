# UI æ§åˆ¶å±‚æ¶æ„æ–‡æ¡£

## æ¦‚è¿°

`autowsgr/ui/` åŒ…å®ç°æ¸¸æˆå…¨éƒ¨é¡µé¢çš„è¯†åˆ«ã€çŠ¶æ€æŸ¥è¯¢ä¸å¯¼èˆªæ“ä½œã€‚
é‡‡ç”¨ **ä¸€é¡µé¢ä¸€æ§åˆ¶å™¨** æ¨¡å¼ï¼Œæ¯ä¸ªæ¸¸æˆé¡µé¢å¯¹åº”ä¸€ä¸ª Python æ¨¡å—ã€‚

### ä¸‰å±‚èŒè´£

| å±‚çº§ | æ¨¡å— | èŒè´£ |
|------|------|------|
| **åŸºç¡€è®¾æ–½** | `page.py` | é¡µé¢æ³¨å†Œä¸­å¿ƒã€å¯¼èˆªéªŒè¯ (`wait_for_page` / `wait_leave_page`) |
| **æ‹“æ‰‘å£°æ˜** | `navigation.py` | å¯¼èˆªæ ‘å®šä¹‰ã€è·¯å¾„æŸ¥æ‰¾ (BFS) |
| **é¡µé¢æ§åˆ¶å™¨** | `main_page.py` ç­‰ | å„é¡µé¢çš„è¯†åˆ«ã€çŠ¶æ€æŸ¥è¯¢ã€æ“ä½œåŠ¨ä½œ |

---

## å¯¼èˆªæ ‘

```
ä¸»é¡µé¢ (MainPage) â† ROOT
â”œâ”€â”€ åœ°å›¾é¡µé¢ (MapPage)                  â† ç‚¹å‡»ã€Œå‡ºå¾ã€(0.9375, 0.8889)
â”‚   â”œâ”€â”€ [é¢æ¿åˆ‡æ¢] å‡ºå¾/æ¼”ä¹ /è¿œå¾/æˆ˜å½¹/å†³æˆ˜ â† MapPanel enum
â”‚   â””â”€â”€ å‡ºå¾å‡†å¤‡ (BattlePreparationPage) â† ç‚¹å‡»åœ°å›¾èŠ‚ç‚¹
â”‚       â””â”€â”€ â†’ æµ´å®¤ (BathPage)           â† è·¨çº§: å³ä¸Šè§’ ğŸ”§ (0.875, 0.037)
â”‚
â”œâ”€â”€ ä»»åŠ¡é¡µé¢ (MissionPage)              â† ç‚¹å‡»ã€Œä»»åŠ¡ã€(0.6833, 0.8889)
â”‚
â”œâ”€â”€ åé™¢é¡µé¢ (BackyardPage)             â† ç‚¹å‡»ä¸»é¡µå›¾æ ‡ ğŸ› (0.0469, 0.1481)
â”‚   â”œâ”€â”€ æµ´å®¤ (BathPage)                â† ç‚¹å‡» (0.3125, 0.3704)
â”‚   â”‚   â””â”€â”€ é€‰æ‹©ä¿®ç† (ChooseRepairPage) â† ç‚¹å‡»å³ä¸Šè§’ (0.9375, 0.0556)
â”‚   â””â”€â”€ é£Ÿå ‚ (CanteenPage)             â† ç‚¹å‡» (0.7292, 0.7407)
â”‚
â””â”€â”€ ä¾§è¾¹æ  (SidebarPage)               â† ç‚¹å‡» â‰¡ (0.0438, 0.8963)
    â”œâ”€â”€ å»ºé€  (BuildPage)               â† ç‚¹å‡» (0.1563, 0.3704)
    â”‚   â””â”€â”€ [æ ‡ç­¾] å»ºé€ /è§£ä½“/å¼€å‘/åºŸå¼ƒ  â† BuildTab enum
    â”œâ”€â”€ å¼ºåŒ– (IntensifyPage)           â† ç‚¹å‡» (0.1563, 0.5000)
    â”‚   â””â”€â”€ [æ ‡ç­¾] å¼ºåŒ–/æ”¹ä¿®/æŠ€èƒ½      â† IntensifyTab enum
    â””â”€â”€ å¥½å‹ (FriendPage)              â† ç‚¹å‡» (0.1563, 0.7593)
```

### è·¨çº§å¿«æ·é€šé“ (Cross Edges)

| èµ·ç‚¹ | ç»ˆç‚¹ | è¯´æ˜ |
|------|------|------|
| å‡ºå¾å‡†å¤‡ | æµ´å®¤ | å³ä¸Šè§’ ğŸ”§ ä¿®ç†å¿«æ·å…¥å£ |
| æµ´å®¤ | ä¸»é¡µé¢ | â— å¯ç›´æ¥è·³å› (è·³è¿‡åé™¢) |
| é£Ÿå ‚ | ä¸»é¡µé¢ | â— å¯ç›´æ¥è·³å› (è·³è¿‡åé™¢) |

### é¡µé¢å†…æ ‡ç­¾ç»„ (Panel / Tab)

æ ‡ç­¾ç»„æˆå‘˜å…±äº«åŒä¸€é¡µé¢è¯†åˆ«ç­¾åï¼Œé€šè¿‡æ§åˆ¶å™¨çš„ `switch_panel()` / `switch_tab()` åˆ‡æ¢ï¼Œ
ä¸ä½œä¸ºç‹¬ç«‹é¡µé¢å‡ºç°åœ¨å¯¼èˆªå›¾ä¸­ã€‚

| é¡µé¢æ§åˆ¶å™¨ | æ ‡ç­¾æˆå‘˜ | åˆ‡æ¢æ–¹æ³• |
|-----------|---------|----------|
| `MapPage` | å‡ºå¾ / æ¼”ä¹  / è¿œå¾ / æˆ˜å½¹ / å†³æˆ˜ | `switch_panel(MapPanel.XXX)` |
| `BuildPage` | å»ºé€  / è§£ä½“ / å¼€å‘ / åºŸå¼ƒ | `switch_tab(BuildTab.XXX)` |
| `IntensifyPage` | å¼ºåŒ– / æ”¹ä¿® / æŠ€èƒ½ | `switch_tab(IntensifyTab.XXX)` |

---

## é¡µé¢æ§åˆ¶å™¨ â€” å®ŒæˆçŠ¶æ€

### âœ… ç­¾åå·²é‡‡é›† (å¯ç”¨äºç”Ÿäº§)

| æ§åˆ¶å™¨ | æ¨¡å— | ç­¾åæ–¹å¼ | å¯¼èˆª |
|--------|------|----------|------|
| `MainPage` | `main_page.py` | 7 è§„åˆ™ PixelSignature | 4 ç›®æ ‡: å‡ºå¾/ä»»åŠ¡/ä¾§è¾¹æ /ä¸»é¡µ |
| `MapPage` | `map_page.py` | 5 é¢æ¿ + OCR åœ°å›¾è¯†åˆ« | é¢æ¿åˆ‡æ¢ã€ç« èŠ‚å¯¼èˆªã€åœ°å›¾é€‰æ‹© |
| `BattlePreparationPage` | `battle_preparation.py` | èˆ°é˜Ÿ+é¢æ¿è”åˆæ£€æµ‹ | èˆ°é˜Ÿé€‰æ‹©ã€é¢æ¿åˆ‡æ¢ã€å¼€å§‹å‡ºå¾ |
| `SidebarPage` | `sidebar_page.py` | 6 è§„åˆ™ PixelSignature | 3 ç›®æ ‡: å»ºé€ /å¼ºåŒ–/å¥½å‹ |

### ğŸ”§ ç­¾åå¾…é‡‡é›† (Stub â€” æ‹“æ‰‘ä¸æ¥å£å·²å£°æ˜)

| æ§åˆ¶å™¨ | æ¨¡å— | å¾…é‡‡é›†å†…å®¹ | å·²å£°æ˜å¯¼èˆª |
|--------|------|-----------|-----------|
| `MissionPage` | `mission_page.py` | é¡µé¢åƒç´ ç­¾å | â— è¿”å›ä¸»é¡µé¢ |
| `BackyardPage` | `backyard_page.py` | é¡µé¢åƒç´ ç­¾å | æµ´å®¤ã€é£Ÿå ‚ã€â— è¿”å› |
| `BathPage` | `bath_page.py` | é¡µé¢åƒç´ ç­¾å | é€‰æ‹©ä¿®ç†ã€â— è¿”å› |
| `CanteenPage` | `canteen_page.py` | é¡µé¢åƒç´ ç­¾å | â— è¿”å›åé™¢ |
| `BuildPage` | `build_page.py` | é¡µé¢åƒç´ ç­¾åã€æ ‡ç­¾åæ ‡ç²¾ç¡®åŒ– | æ ‡ç­¾åˆ‡æ¢ã€â— è¿”å› |
| `IntensifyPage` | `intensify_page.py` | é¡µé¢åƒç´ ç­¾åã€æ ‡ç­¾åæ ‡ç²¾ç¡®åŒ– | æ ‡ç­¾åˆ‡æ¢ã€â— è¿”å› |
| `FriendPage` | `friend_page.py` | é¡µé¢åƒç´ ç­¾å | â— è¿”å›ä¾§è¾¹æ  |

### â¬œ æœªå®ç°

ä»¥ä¸‹é¡µé¢åœ¨æ—§ä»£ç ä¸­å­˜åœ¨ï¼Œä½†å½“å‰ç¼ºä¹è¶³å¤Ÿä¿¡æ¯ï¼Œæš‚ä¸åˆ›å»ºæ§åˆ¶å™¨:

- `support_set_page` â€” æ”¯æ´è®¾ç½® (å…¥å£è·¯å¾„ä¸ç¡®å®š)
- `choose_repair_page` â€” é€‰æ‹©ä¿®ç† (ä»…åœ¨ `navigation.py` æ‹“æ‰‘ä¸­å£°æ˜)
- `news_page` / `sign_page` â€” å¼¹çª—å‹é¡µé¢ (éå¸¸è§„å¯¼èˆªæ ‘æˆå‘˜)

---

## æ§åˆ¶å™¨è®¾è®¡æ¨¡å¼

### ç±»ç»“æ„

```python
class XxxPage:
    def __init__(self, ctrl: AndroidController) -> None:
        self._ctrl = ctrl

    # â”€â”€ é¡µé¢è¯†åˆ« (staticmethod) â”€â”€
    @staticmethod
    def is_current_page(screen: np.ndarray) -> bool: ...

    # â”€â”€ çŠ¶æ€æŸ¥è¯¢ (staticmethodï¼Œå¯é€‰) â”€â”€
    @staticmethod
    def get_xxx(screen: np.ndarray) -> ...: ...

    # â”€â”€ æ“ä½œåŠ¨ä½œ (å®ä¾‹æ–¹æ³•) â”€â”€
    def navigate_to(self, target: XxxTarget) -> None: ...
    def go_back(self) -> None: ...
```

### å¯¼èˆªéªŒè¯

æ‰€æœ‰å¯¼èˆªæ“ä½œéµå¾ªï¼š

1. **ç‚¹å‡»** â€” `self._ctrl.click(rx, ry)`
2. **éªŒè¯** â€” `wait_for_page()` (ç¡®è®¤åˆ°è¾¾) æˆ– `wait_leave_page()` (ç¡®è®¤ç¦»å¼€)
3. **è¶…æ—¶** â€” æŠ›å‡º `NavigationError`

ç­¾åå·²é‡‡é›†çš„æ§åˆ¶å™¨è‡ªåŠ¨å¯ç”¨éªŒè¯ã€‚ç­¾åå¾…é‡‡é›†çš„æ§åˆ¶å™¨æ ‡è®° `# TODO`ã€‚

### åæ ‡ä½“ç³»

- æ‰€æœ‰åæ ‡ä¸º **ç›¸å¯¹å€¼** (0.0â€“1.0)
- ç”±æ—§ä»£ç  960Ã—540 ç»å¯¹åæ ‡æ¢ç®—: `rx = x / 960`, `ry = y / 540`
- åˆ†ä¸ºä¸¤ç±»:
  - **æ¢æµ‹åæ ‡** â€” é‡‡æ ·åƒç´ é¢œè‰²ç”¨äºçŠ¶æ€æ£€æµ‹
  - **ç‚¹å‡»åæ ‡** â€” æ‰§è¡Œæ“ä½œ

---

## é¡µé¢æ³¨å†Œä¸­å¿ƒ

`page.py` ç»´æŠ¤å…¨å±€æ³¨å†Œè¡¨ `_PAGE_REGISTRY`:

```python
from autowsgr.ui import get_current_page

screen = ctrl.screenshot()
page = get_current_page(screen)  # "ä¸»é¡µé¢" | "åœ°å›¾é¡µé¢" | ... | None
```

æ³¨å†Œåœ¨ `__init__.py` ä¸­è‡ªåŠ¨å®Œæˆã€‚æ–°å¢é¡µé¢åªéœ€:

1. åœ¨æ§åˆ¶å™¨æ¨¡å—ä¸­å®ç° `is_current_page()`
2. åœ¨ `__init__.py` ä¸­ `register_page("é¡µé¢å", XxxPage.is_current_page)`

---

## å¯¼èˆªè·¯å¾„æŸ¥æ‰¾

`navigation.py` æä¾› BFS è·¯å¾„æŸ¥æ‰¾:

```python
from autowsgr.ui.navigation import find_path, NavEdge

path: list[NavEdge] | None = find_path("ä¸»é¡µé¢", "å»ºé€ é¡µé¢")
if path:
    for edge in path:
        print(f"{edge.source} â†’ {edge.target}: click {edge.click}")
        # ctrl.click(*edge.click)
```

è¾“å‡ºç¤ºä¾‹:
```
ä¸»é¡µé¢ â†’ ä¾§è¾¹æ : click (0.0438, 0.8963)
ä¾§è¾¹æ  â†’ å»ºé€ é¡µé¢: click (0.1563, 0.3704)
```

---

## æ—§ä»£ç  (V1) å¯¹ç…§

| V1 æ¦‚å¿µ | V2 å¯¹åº” | è¯´æ˜ |
|---------|---------|------|
| `ALL_PAGES` (23 é¡µé¢) | `navigation.ALL_PAGES` (12 é¡µé¢) | V2 å°†æ ‡ç­¾ç»„æˆå‘˜ä½œä¸ºé¡µé¢å†… Panel/Tab |
| `page_tree` + LCA | `NAV_GRAPH` + BFS | æœ‰å‘å›¾æ›¿ä»£æ ‘ï¼Œæ”¯æŒè·¨çº§è¾¹ |
| `timer.now_page` | `get_current_page(screen)` | æ— çŠ¶æ€è¯†åˆ«ï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤ |
| `goto_game_page()` | `MainPage.navigate_to()` ç­‰ | æ¯ä¸ªæ§åˆ¶å™¨ç‹¬ç«‹è´Ÿè´£éªŒè¯ |
| `identify_page()` | `get_current_page()` | éå†æ³¨å†Œè¡¨ |
| `image_exist()` + åƒç´ æ£€æŸ¥ | `PixelSignature` + `PixelChecker` | çº¯åƒç´ æ–¹æ¡ˆï¼Œæ— æ¨¡æ¿å›¾ä¾èµ– |
| ç»å¯¹åæ ‡ (960Ã—540) | ç›¸å¯¹åæ ‡ (0.0â€“1.0) | åˆ†è¾¨ç‡æ— å…³ |

---

## æ–‡ä»¶ç»“æ„

```
autowsgr/ui/
â”œâ”€â”€ __init__.py               # å¯¼å‡º + é¡µé¢æ³¨å†Œ
â”œâ”€â”€ page.py                   # æ³¨å†Œä¸­å¿ƒ + å¯¼èˆªéªŒè¯
â”œâ”€â”€ navigation.py             # å¯¼èˆªæ ‘å®šä¹‰ + è·¯å¾„æŸ¥æ‰¾
â”œâ”€â”€ main_page.py              # âœ… ä¸»é¡µé¢
â”œâ”€â”€ map_page.py               # âœ… åœ°å›¾é¡µé¢ (å« 5 ä¸ªé¢æ¿)
â”œâ”€â”€ battle_preparation.py     # âœ… å‡ºå¾å‡†å¤‡
â”œâ”€â”€ sidebar_page.py           # âœ… ä¾§è¾¹æ 
â”œâ”€â”€ mission_page.py           # ğŸ”§ ä»»åŠ¡é¡µé¢
â”œâ”€â”€ backyard_page.py          # ğŸ”§ åé™¢é¡µé¢
â”œâ”€â”€ bath_page.py              # ğŸ”§ æµ´å®¤
â”œâ”€â”€ canteen_page.py           # ğŸ”§ é£Ÿå ‚
â”œâ”€â”€ build_page.py             # ğŸ”§ å»ºé€  (å« 4 ä¸ªæ ‡ç­¾)
â”œâ”€â”€ intensify_page.py         # ğŸ”§ å¼ºåŒ– (å« 3 ä¸ªæ ‡ç­¾)
â””â”€â”€ friend_page.py            # ğŸ”§ å¥½å‹
```

âœ… = ç­¾åå·²é‡‡é›†ã€å¯ç”¨äºç”Ÿäº§
ğŸ”§ = æ¥å£å·²å£°æ˜ã€ç­¾åå¾…é‡‡é›†

---

## ç­¾åé‡‡é›†æŒ‡å—

ä¸º stub é¡µé¢è¡¥å……ç­¾åçš„æ­¥éª¤:

1. å¯¼èˆªåˆ°ç›®æ ‡é¡µé¢ï¼Œä½¿ç”¨ `ctrl.screenshot()` è·å–æˆªå›¾
2. é€‰æ‹© 5â€“8 ä¸ªç¨³å®šç‰¹å¾ç‚¹ (é¿å…åŠ¨æ€åŒºåŸŸ)
3. ä½¿ç”¨å·¥å…·æå–åƒç´  RGB å€¼å’Œç›¸å¯¹åæ ‡
4. æ„å»º `PixelSignature`ï¼Œè®¾ç½®åˆé€‚ `tolerance` (é€šå¸¸ 30.0)
5. æ›¿æ¢ `is_current_page()` å®ç°
6. åœ¨ `__init__.py` ä¸­æ³¨å†Œ (å·²é¢„æ³¨å†Œ)
7. è¿è¡Œæµ‹è¯•éªŒè¯

å·¥å…·å‚è€ƒ: `sig.py` (æ ¹ç›®å½•) åŒ…å«å·²é‡‡é›†çš„ç­¾åæ ·ä¾‹ã€‚
