"""åé™¢é¡µé¢ UI æ§åˆ¶å™¨ã€‚

è¦†ç›–æ¸¸æˆ **åé™¢** (ä¸»é¡µå›¾æ ‡å…¥å£/ä¼‘æ¯åŒº) çš„å¯¼èˆªäº¤äº’ã€‚

é¡µé¢å…¥å£:
    ä¸»é¡µé¢ â†’ ç‚¹å‡»ä¸»é¡µå›¾æ ‡ ğŸ›

é¡µé¢å¸ƒå±€::

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ â—  åé™¢                                                     â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                                              â”‚
    â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
    â”‚         â”‚  æµ´ å®¤   â”‚  (ä¿®ç†åŒºåŸŸ)                             â”‚
    â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
    â”‚                                                              â”‚
    â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
    â”‚                              â”‚  é£Ÿ å ‚   â”‚  (æ–™ç†/è¡¥ç»™)       â”‚
    â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
    â”‚                                                              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¯¼èˆªç›®æ ‡:

- **æµ´å®¤**: è¿›å…¥ä¿®ç†èˆ°èˆ¹é¡µé¢
- **é£Ÿå ‚**: è¿›å…¥æ–™ç†/é£Ÿå ‚é¡µé¢

åæ ‡ä½“ç³»:
    æ‰€æœ‰åæ ‡ä¸ºç›¸å¯¹å€¼ (0.0â€“1.0)ï¼Œç”± 960Ã—540 ç»å¯¹åæ ‡æ¢ç®—ã€‚

.. note::
    é¡µé¢åƒç´ ç­¾åæš‚æœªé‡‡é›† (TODO)ã€‚å½“å‰ä»…å£°æ˜æ‹“æ‰‘å…³ç³»å’Œæ“ä½œæ¥å£ã€‚

ä½¿ç”¨æ–¹å¼::

    from autowsgr.ui.backyard_page import BackyardPage, BackyardTarget

    page = BackyardPage(ctrl)
    page.go_to_bath()
    page.go_back()
"""

from __future__ import annotations

import enum

import numpy as np
from loguru import logger

from autowsgr.emulator.controller import AndroidController
from autowsgr.ui.page import click_and_wait_for_page, wait_for_page
from autowsgr.vision.matcher import (
    MatchStrategy,
    PixelChecker,
    PixelRule,
    PixelSignature,
)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æšä¸¾
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


class BackyardTarget(enum.Enum):
    """åé™¢é¡µé¢å¯å¯¼èˆªçš„ç›®æ ‡ã€‚"""

    BATH = "æµ´å®¤"
    CANTEEN = "é£Ÿå ‚"


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# é¡µé¢è¯†åˆ«ç­¾å
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PAGE_SIGNATURE = PixelSignature(
    name="åé™¢",
    strategy=MatchStrategy.ALL,
    rules=[
        PixelRule.of(0.6990, 0.8389, (193, 98, 66), tolerance=30.0),
        PixelRule.of(0.2583, 0.7750, (240, 222, 146), tolerance=30.0),
        PixelRule.of(0.3344, 0.5222, (246, 119, 76), tolerance=30.0),
        PixelRule.of(0.5880, 0.2861, (255, 254, 250), tolerance=30.0),
        PixelRule.of(0.9031, 0.4380, (255, 254, 250), tolerance=30.0),
    ],
)
"""åé™¢é¡µé¢åƒç´ ç­¾å â€” æ£€æµ‹åé™¢èƒŒæ™¯åŠè£…é¥°ç‰¹å¾ã€‚"""


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ç‚¹å‡»åæ ‡
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CLICK_BACK: tuple[float, float] = (0.022, 0.058)
"""å›é€€æŒ‰é’® (â—)ï¼Œè¿”å›ä¸»é¡µé¢ã€‚"""

CLICK_NAV: dict[BackyardTarget, tuple[float, float]] = {
    BackyardTarget.BATH:    (0.3125, 0.3704),
    BackyardTarget.CANTEEN: (0.7292, 0.7407),
}
"""å¯¼èˆªæŒ‰é’®ç‚¹å‡»åæ ‡ã€‚

åæ ‡æ¢ç®—: æ—§ä»£ç  (300, 200) / (700, 400) Ã· (960, 540)ã€‚
"""


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# é¡µé¢æ§åˆ¶å™¨
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


class BackyardPage:
    """åé™¢é¡µé¢æ§åˆ¶å™¨ã€‚

    Parameters
    ----------
    ctrl:
        Android è®¾å¤‡æ§åˆ¶å™¨å®ä¾‹ã€‚
    """

    def __init__(self, ctrl: AndroidController) -> None:
        self._ctrl = ctrl

    # â”€â”€ é¡µé¢è¯†åˆ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    @staticmethod
    def is_current_page(screen: np.ndarray) -> bool:
        """åˆ¤æ–­æˆªå›¾æ˜¯å¦ä¸ºåé™¢é¡µé¢ã€‚

        é€šè¿‡ 5 ä¸ªç‰¹å¾åƒç´ ç‚¹ (èƒŒæ™¯åŠè£…é¥°) å…¨éƒ¨åŒ¹é…åˆ¤å®šã€‚

        Parameters
        ----------
        screen:
            æˆªå›¾ (HÃ—WÃ—3, RGB)ã€‚
        """
        result = PixelChecker.check_signature(screen, PAGE_SIGNATURE)
        return result.matched

    # â”€â”€ å¯¼èˆª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def navigate_to(self, target: BackyardTarget) -> None:
        """ç‚¹å‡»å¯¼èˆªæŒ‰é’®ï¼Œè¿›å…¥æŒ‡å®šå­é¡µé¢ã€‚

        Parameters
        ----------
        target:
            å¯¼èˆªç›®æ ‡ã€‚

        Raises
        ------
        NavigationError
            è¶…æ—¶æœªåˆ°è¾¾ç›®æ ‡é¡µé¢ã€‚
        """
        from autowsgr.ui.bath_page import BathPage
        from autowsgr.ui.canteen_page import CanteenPage

        target_checker = {
            BackyardTarget.BATH: BathPage.is_current_page,
            BackyardTarget.CANTEEN: CanteenPage.is_current_page,
        }
        logger.info("[UI] åé™¢ â†’ {}", target.value)
        click_and_wait_for_page(
            self._ctrl,
            click_coord=CLICK_NAV[target],
            checker=target_checker[target],
            source="åé™¢",
            target=target.value,
        )

    def go_to_bath(self) -> None:
        """è¿›å…¥æµ´å®¤ (ä¿®ç†èˆ°èˆ¹)ã€‚"""
        self.navigate_to(BackyardTarget.BATH)

    def go_to_canteen(self) -> None:
        """è¿›å…¥é£Ÿå ‚ã€‚"""
        self.navigate_to(BackyardTarget.CANTEEN)

    # â”€â”€ å›é€€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def go_back(self) -> None:
        """ç‚¹å‡»å›é€€æŒ‰é’® (â—)ï¼Œè¿”å›ä¸»é¡µé¢ã€‚

        Raises
        ------
        NavigationError
            è¶…æ—¶ä»åœ¨åé™¢é¡µé¢ã€‚
        """
        from autowsgr.ui.main_page import MainPage

        logger.info("[UI] åé™¢ â†’ è¿”å›ä¸»é¡µé¢")
        click_and_wait_for_page(
            self._ctrl,
            click_coord=CLICK_BACK,
            checker=MainPage.is_current_page,
            source="åé™¢",
            target="ä¸»é¡µé¢",
        )
