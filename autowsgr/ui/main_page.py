"""ä¸»é¡µé¢ UI æ§åˆ¶å™¨ã€‚

è¦†ç›–æ¸¸æˆ **ä¸»é¡µé¢** (æ¯æ¸¯ç•Œé¢) çš„å¯¼èˆªäº¤äº’ã€‚

é¡µé¢å¸ƒå±€::

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Lv.  æç£å      ğŸ›¢ æ²¹  ğŸ”© å¼¹  ğŸ§± é’¢  ğŸ¯ é“    ğŸ’ x  âŠ•  â”‚
    â”‚ ğŸ                                                           â”‚
    â”‚ ğŸ›(home)                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚                                             â”‚  æ´»åŠ¨æ¨ªå¹…  â”‚  â”‚
    â”‚                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                 (ç§˜ä¹¦èˆ°ç«‹ç»˜)                                 â”‚
    â”‚                                                              â”‚
    â”‚                                                              â”‚
    â”‚                                              å‰©ä½™ N å¤©      â”‚
    â”‚ â‰¡   âœ‰   â˜…                        ä»»åŠ¡   èˆ¹å    å‡ºå¾      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4 ä¸ªå¯¼èˆªæ§ä»¶:

- **å‡ºå¾** (å³ä¸‹): è¿›å…¥åœ°å›¾é€‰æ‹©é¡µé¢ (map_page)ï¼Œé€€å‡ºæ§ä»¶åœ¨å·¦ä¸Šè§’ â—
- **ä»»åŠ¡** (ä¸­ä¸‹): è¿›å…¥ä»»åŠ¡é¡µé¢ (task_page)ï¼Œé€€å‡ºæ§ä»¶åœ¨å·¦ä¸Šè§’ â—
- **ä¾§è¾¹æ ** (å·¦ä¸‹ â‰¡): æ‰“å¼€ä¾§è¾¹æ  (sidebar_page)ï¼Œé€€å‡ºæ§ä»¶åœ¨å·¦ä¸‹è§’ (åŒä¸€æŒ‰é’®)
- **ä¸»é¡µ** (å·¦ä¾§ ğŸ›): è¿›å…¥ä¸»é¡µ (home_page)ï¼Œé€€å‡ºæ§ä»¶åœ¨å·¦ä¸Šè§’ â—

åæ ‡ä½“ç³»:
    æ‰€æœ‰åæ ‡ä¸ºç›¸å¯¹å€¼ (0.0â€“1.0)ï¼Œä¸åˆ†è¾¨ç‡æ— å…³ã€‚

ä½¿ç”¨æ–¹å¼::

    from autowsgr.ui.main_page import MainPage, MainPageTarget

    page = MainPage(ctrl)

    # é¡µé¢è¯†åˆ«
    screen = ctrl.screenshot()
    if MainPage.is_current_page(screen):
        page.navigate_to(MainPageTarget.SORTIE)

    # ä»å­é¡µé¢è¿”å›
    page.return_from(MainPageTarget.SORTIE)
"""

from __future__ import annotations

import enum

import numpy as np
from loguru import logger

from autowsgr.emulator.controller import AndroidController
from autowsgr.ui.page import wait_for_page, wait_leave_page
from autowsgr.vision.matcher import (
    Color,
    MatchStrategy,
    PixelChecker,
    PixelRule,
    PixelSignature,
)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æšä¸¾
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


class MainPageTarget(enum.Enum):
    """ä¸»é¡µé¢å¯å¯¼èˆªçš„ç›®æ ‡ã€‚"""

    SORTIE = "å‡ºå¾"
    TASK = "ä»»åŠ¡"
    SIDEBAR = "ä¾§è¾¹æ "
    HOME = "ä¸»é¡µ"


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# é¡µé¢è¯†åˆ«ç­¾å
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PAGE_SIGNATURE = PixelSignature(
    name="main_page",
    strategy=MatchStrategy.ALL,
    rules=[
        PixelRule.of(0.8896, 0.0278, (110, 193, 255), tolerance=30.0),
        PixelRule.of(0.7885, 0.0352, (252, 144, 71), tolerance=30.0),
        PixelRule.of(0.6813, 0.0333, (82, 82, 82), tolerance=30.0),
        PixelRule.of(0.5781, 0.0389, (64, 98, 63), tolerance=30.0),
        PixelRule.of(0.4750, 0.0278, (158, 198, 109), tolerance=30.0),
        PixelRule.of(0.9719, 0.9019, (136, 143, 149), tolerance=30.0),
        PixelRule.of(0.0583, 0.8833, (250, 250, 248), tolerance=30.0),
    ],
)
"""ä¸»é¡µé¢åƒç´ ç­¾å â€” æ£€æµ‹èµ„æºæ  + è§’è½ç‰¹å¾ã€‚"""

_STATE_TOLERANCE = 30.0
"""é€šç”¨é¢œè‰²å®¹å·®ã€‚"""


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å¯¼èˆªæŒ‰é’®ç‚¹å‡»åæ ‡
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CLICK_NAV: dict[MainPageTarget, tuple[float, float]] = {
    MainPageTarget.SORTIE:  (0.9375, 0.8981),
    MainPageTarget.TASK:    (0.6823, 0.9037),
    MainPageTarget.SIDEBAR: (0.0490, 0.8981),
    MainPageTarget.HOME:    (0.0531, 0.1519),
}
"""4 ä¸ªå¯¼èˆªæ§ä»¶çš„ç‚¹å‡»åæ ‡ã€‚"""


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å­é¡µé¢é€€å‡ºåæ ‡
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EXIT_TOP_LEFT: tuple[float, float] = (0.022, 0.058)
"""å·¦ä¸Šè§’å›é€€æŒ‰é’® â— (å‡ºå¾/ä»»åŠ¡/ä¸»é¡µ é€šç”¨)ã€‚"""

EXIT_SIDEBAR: tuple[float, float] = (0.0490, 0.8981)
"""ä¾§è¾¹æ é€€å‡º â€” å·¦ä¸‹è§’åŒä¸€æŒ‰é’® (â‰¡ åˆ‡æ¢)ã€‚"""

CLICK_EXIT: dict[MainPageTarget, tuple[float, float]] = {
    MainPageTarget.SORTIE:  EXIT_TOP_LEFT,
    MainPageTarget.TASK:    EXIT_TOP_LEFT,
    MainPageTarget.HOME:    EXIT_TOP_LEFT,
    MainPageTarget.SIDEBAR: EXIT_SIDEBAR,
}
"""å­é¡µé¢é€€å‡ºæ§ä»¶çš„ç‚¹å‡»åæ ‡ã€‚"""


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å­é¡µé¢è¯†åˆ«ç­¾å (ç”¨äºå†’çƒŸæµ‹è¯•éªŒè¯)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

MAP_PAGE_SIGNATURE = PixelSignature(
    name="map_page",
    strategy=MatchStrategy.ALL,
    rules=[
        PixelRule.of(0.8938, 0.0602, (241, 96, 69), tolerance=30.0),
        PixelRule.of(0.9672, 0.0472, (21, 38, 66), tolerance=30.0),
        PixelRule.of(0.6297, 0.1046, (23, 42, 72), tolerance=30.0),
        PixelRule.of(0.3391, 0.1019, (28, 44, 69), tolerance=30.0),
        PixelRule.of(0.1833, 0.1083, (17, 33, 58), tolerance=30.0),
    ],
)
"""å‡ºå¾ (åœ°å›¾é€‰æ‹©) é¡µé¢ç­¾åã€‚"""

SIDEBAR_PAGE_SIGNATURE = PixelSignature(
    name="sidebar_page",
    strategy=MatchStrategy.ALL,
    rules=[
        PixelRule.of(0.0406, 0.0787, (59, 59, 59), tolerance=30.0),
        PixelRule.of(0.0443, 0.2074, (51, 51, 51), tolerance=30.0),
        PixelRule.of(0.0417, 0.3426, (56, 56, 56), tolerance=30.0),
        PixelRule.of(0.0422, 0.4583, (60, 62, 61), tolerance=30.0),
        PixelRule.of(0.0417, 0.5935, (53, 53, 53), tolerance=30.0),
        PixelRule.of(0.0422, 0.7231, (59, 59, 59), tolerance=30.0),
    ],
)
"""ä¾§è¾¹æ é¡µé¢ç­¾åã€‚"""

SUB_PAGE_SIGNATURES: dict[MainPageTarget, PixelSignature | None] = {
    MainPageTarget.SORTIE:  MAP_PAGE_SIGNATURE,
    MainPageTarget.TASK:    None,  # TODO: å¾…é‡‡é›†
    MainPageTarget.SIDEBAR: SIDEBAR_PAGE_SIGNATURE,
    MainPageTarget.HOME:    None,  # TODO: å¾…é‡‡é›†
}
"""å­é¡µé¢ç­¾å (``None`` è¡¨ç¤ºå°šæœªé‡‡é›†ï¼Œä»…ç”¨ "éä¸»é¡µé¢" åˆ¤å®š)ã€‚"""


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# é¡µé¢æ§åˆ¶å™¨
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


class MainPage:
    """ä¸»é¡µé¢ (æ¯æ¸¯ç•Œé¢) æ§åˆ¶å™¨ã€‚

    **çŠ¶æ€æŸ¥è¯¢** ä¸º ``staticmethod``ï¼Œåªéœ€æˆªå›¾å³å¯è°ƒç”¨ã€‚
    **æ“ä½œåŠ¨ä½œ** ä¸ºå®ä¾‹æ–¹æ³•ï¼Œé€šè¿‡æ³¨å…¥çš„æ§åˆ¶å™¨æ‰§è¡Œã€‚

    Parameters
    ----------
    ctrl:
        Android è®¾å¤‡æ§åˆ¶å™¨å®ä¾‹ã€‚
    """

    def __init__(self, ctrl: AndroidController) -> None:
        self._ctrl = ctrl

    # â”€â”€ é¡µé¢è¯†åˆ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    @staticmethod
    def is_current_page(screen: np.ndarray) -> bool:
        """åˆ¤æ–­æˆªå›¾æ˜¯å¦ä¸ºä¸»é¡µé¢ã€‚

        é€šè¿‡ 8 ä¸ªç‰¹å¾åƒç´ ç‚¹ (èµ„æºæ  + è§’è½) å…¨éƒ¨åŒ¹é…åˆ¤å®šã€‚

        Parameters
        ----------
        screen:
            æˆªå›¾ (HÃ—WÃ—3, RGB)ã€‚
        """
        result = PixelChecker.check_signature(screen, PAGE_SIGNATURE)
        return result.matched

    # â”€â”€ å­é¡µé¢è¯†åˆ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    @staticmethod
    def is_sub_page(screen: np.ndarray, target: MainPageTarget) -> bool | None:
        """æ£€æµ‹æˆªå›¾æ˜¯å¦ä¸ºæŒ‡å®šå­é¡µé¢ã€‚

        Parameters
        ----------
        screen:
            æˆªå›¾ (HÃ—WÃ—3, RGB)ã€‚
        target:
            ç›®æ ‡å­é¡µé¢ã€‚

        Returns
        -------
        bool | None
            åŒ¹é…ç»“æœã€‚æ— ç­¾åæ—¶è¿”å› ``None``ã€‚
        """
        sig = SUB_PAGE_SIGNATURES.get(target)
        if sig is None:
            return None
        result = PixelChecker.check_signature(screen, sig)
        return result.matched

    # â”€â”€ å¯¼èˆª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def navigate_to(self, target: MainPageTarget) -> None:
        """ç‚¹å‡»å¯¼èˆªæ§ä»¶ï¼Œè¿›å…¥æŒ‡å®šå­é¡µé¢ã€‚

        ç‚¹å‡»ååå¤æˆªå›¾éªŒè¯ï¼Œç¡®è®¤å·²åˆ°è¾¾ç›®æ ‡é¡µé¢ (æˆ–å·²ç¦»å¼€ä¸»é¡µé¢)ã€‚

        Parameters
        ----------
        target:
            å¯¼èˆªç›®æ ‡ã€‚

        Raises
        ------
        NavigationError
            è¶…æ—¶æœªåˆ°è¾¾ç›®æ ‡é¡µé¢ã€‚
        """
        logger.info("[UI] ä¸»é¡µé¢ â†’ {}", target.value)
        self._ctrl.click(*CLICK_NAV[target])

        # éªŒè¯å¯¼èˆªæˆåŠŸ
        sig = SUB_PAGE_SIGNATURES.get(target)
        if sig is not None:
            # ç›®æ ‡é¡µé¢æœ‰ç­¾å â€” ç­‰å¾…ç­¾ååŒ¹é…
            wait_for_page(
                self._ctrl,
                lambda s, t=target: MainPage.is_sub_page(s, t) is True,
                source="ä¸»é¡µé¢",
                target=target.value,
            )
        else:
            # æ— ç­¾å â€” é™çº§ä¸ºç­‰å¾…ç¦»å¼€ä¸»é¡µé¢
            wait_leave_page(
                self._ctrl,
                MainPage.is_current_page,
                source="ä¸»é¡µé¢",
                target=target.value,
            )

    def go_to_sortie(self) -> None:
        """ç‚¹å‡»ã€Œå‡ºå¾ã€â€” è¿›å…¥åœ°å›¾é€‰æ‹©é¡µé¢ã€‚"""
        self.navigate_to(MainPageTarget.SORTIE)

    def go_to_task(self) -> None:
        """ç‚¹å‡»ã€Œä»»åŠ¡ã€â€” è¿›å…¥ä»»åŠ¡é¡µé¢ã€‚"""
        self.navigate_to(MainPageTarget.TASK)

    def open_sidebar(self) -> None:
        """ç‚¹å‡»ã€Œâ‰¡ã€â€” æ‰“å¼€ä¾§è¾¹æ ã€‚"""
        self.navigate_to(MainPageTarget.SIDEBAR)

    def go_home(self) -> None:
        """ç‚¹å‡»ä¸»é¡µå›¾æ ‡ â€” è¿›å…¥ä¸»é¡µé¡µé¢ã€‚"""
        self.navigate_to(MainPageTarget.HOME)

    # â”€â”€ è¿”å› â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def return_from(self, target: MainPageTarget) -> None:
        """ç‚¹å‡»å­é¡µé¢é€€å‡ºæ§ä»¶ï¼Œè¿”å›ä¸»é¡µé¢ã€‚

        - å‡ºå¾ / ä»»åŠ¡ / ä¸»é¡µ: å·¦ä¸Šè§’ â— æŒ‰é’®
        - ä¾§è¾¹æ : å·¦ä¸‹è§’ â‰¡ æŒ‰é’® (åŒä¸€åˆ‡æ¢æŒ‰é’®)

        ç‚¹å‡»ååå¤æˆªå›¾éªŒè¯ï¼Œç¡®è®¤å·²è¿”å›ä¸»é¡µé¢ã€‚

        Parameters
        ----------
        target:
            å½“å‰æ‰€åœ¨çš„å­é¡µé¢ã€‚

        Raises
        ------
        NavigationError
            è¶…æ—¶æœªè¿”å›ä¸»é¡µé¢ã€‚
        """
        logger.info("[UI] {} â†’ è¿”å›ä¸»é¡µé¢", target.value)
        self._ctrl.click(*CLICK_EXIT[target])

        # éªŒè¯è¿”å›æˆåŠŸ
        wait_for_page(
            self._ctrl,
            MainPage.is_current_page,
            source=target.value,
            target="ä¸»é¡µé¢",
        )
